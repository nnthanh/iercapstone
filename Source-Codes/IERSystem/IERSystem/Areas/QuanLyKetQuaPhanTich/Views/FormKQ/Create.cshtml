@model IERSystem.Areas.Administrator.Models.FormKQ

@{
    ViewBag.Title = "Create";
    Layout = "~/Areas/Administrator/Views/Shared/_Layout.cshtml";
}

<h2>Tạo form kết quả</h2>


@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <div class="form-horizontal">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>Thêm kết quả thử nghiệm</h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <br>
                    <form id="demo-form2" data-parsley-validate="" class="form-horizontal form-label-left" novalidate="">
                        @Html.ValidationSummary(true)

                        <div class="form-group">
                            <label class="control-label col-md-2 col-sm-2 col-xs-12" for="first-name">
                                Nơi lấy mẫu
                            </label>
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                @Html.TextBoxFor(model => model.NoiLayMau, new { @class = "form-control col-md-4 col-xs-12" })
                                @Html.ValidationMessageFor(model => model.NoiLayMau)
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-2 col-sm-2 col-xs-12" for="first-name">
                                Ngày gửi mẫu
                            </label>
                            <div class="form-group input-group-sm col-md-4 col-sm-4 col-xs-12">
                                @Html.TextBoxFor(model => model.NgayGuiMau, new { @class = "date-picker form-control col-md-7 col-xs-12 active", placeholder = "Nhập ngày gửi mẫu vào đây", required = "required", type = "text", id = "NgayGuiMau" })
                                @Html.ValidationMessageFor(model => model.NgayGuiMau)
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-2 col-sm-2 col-xs-12" for="first-name">
                                Địa chỉ
                            </label>
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                @Html.TextBoxFor(model => model.DiaChi, new { @class = "form-control col-md-4 col-xs-12" })
                                @Html.ValidationMessageFor(model => model.DiaChi)
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-2 col-sm-2 col-xs-12" for="first-name">
                                Loại mẫu
                            </label>
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                <select class="form-control col-md-4 col-xs-12">
                                    <option>Chọn một mẫu</option>
                                    <option>NT</option>
                                    <option>NC</option>
                                    <option>KK</option>
                                    <option>CTR</option>
                                </select>
                                @Html.ValidationMessageFor(model => model.LoaiMau)
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-2 col-sm-2 col-xs-12" for="first-name">
                                Vị trí lấy mẫu
                            </label>
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                @Html.TextBoxFor(model => model.ViTriLayMau, new { @class = "form-control col-md-4 col-xs-12" })
                                @Html.ValidationMessageFor(model => model.ViTriLayMau)
                            </div>
                        </div>

                        @*<div class="form-group">
                                <label class="control-label col-md-2 col-sm-2 col-xs-12" for="first-name">
                                    STT
                                </label>
                                <div class="col-md-4 col-sm-4 col-xs-12">
                                    @Html.TextBoxFor(model => model.STT, new { @class = "form-control col-md-4 col-xs-12" })
                                    @Html.ValidationMessageFor(model => model.STT)
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="control-label col-md-2 col-sm-2 col-xs-12" for="first-name">
                                    Chỉ tiêu
                                </label>
                                <div class="col-md-4 col-sm-4 col-xs-12">
                                    @Html.TextBoxFor(model => model.ChiTieu, new { @class = "form-control col-md-4 col-xs-12" })
                                    @Html.ValidationMessageFor(model => model.ChiTieu)
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="control-label col-md-2 col-sm-2 col-xs-12" for="first-name">
                                    Đơn vị
                                </label>
                                <div class="col-md-4 col-sm-4 col-xs-12">
                                    @Html.TextBoxFor(model => model.DonVi, new { @class = "form-control col-md-4 col-xs-12" })
                                    @Html.ValidationMessageFor(model => model.DonVi)
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="control-label col-md-2 col-sm-2 col-xs-12" for="first-name">
                                    Giá trị
                                </label>
                                <div class="col-md-4 col-sm-4 col-xs-12">
                                    @Html.TextBoxFor(model => model.GiaTri, new { @class = "form-control col-md-4 col-xs-12" })
                                    @Html.ValidationMessageFor(model => model.GiaTri)
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="control-label col-md-2 col-sm-2 col-xs-12" for="first-name">
                                    Phương pháp phân tích
                                </label>
                                <div class="col-md-4 col-sm-4 col-xs-12">
                                    <select class="form-control col-md-4 col-xs-12">
                                        <option>Chọn phương pháp</option>
                                        <option>Hóa nghiệm</option>
                                        <option>Lý nghiệm</option>
                                        <option>Sinh chất</option>
                                        <option>Ống nghiệm</option>
                                    </select>
                                    @Html.ValidationMessageFor(model => model.PhuongPhapPhanTich)
                                </div>
                            </div>*@

                        <h2 class="StepTitle">Thông tin kết quả</h2>
                        <div class="row">
                            <div class="col-md-2 col-sm-2 col-xs-2">
                                <button id="btnThemMau" type="button"
                                        data-toggle="modal" data-target="#themMauModal"
                                        class="btn btn-success">
                                    Thêm Kết Quả
                                </button>
                            </div>
                            <!-- Modal -->
                            <div id="themMauModal" class="modal fade" role="dialog">
                                <div class="modal-dialog">

                                    <!-- Modal content-->
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                                            <h4 class="modal-title">Modal Header</h4>
                                        </div>
                                        <div class="modal-body">
                                            <div class="form-group">
                                                <label for="email">Số thứ tự</label>
                                                <input type="email" class="form-control" id="stt">
                                            </div>
                                            <div class="form-group">
                                                <label for="email">Chỉ tiêu</label>
                                                <input type="email" class="form-control" id="chi-tieu">
                                            </div>
                                            <div class="form-group">
                                                <label for="email">Đơn vị</label>
                                                <input type="email" class="form-control" id="don-vi">
                                            </div>
                                            <div class="form-group">
                                                <label for="email">Giá trị</label>
                                                <input type="email" class="form-control" id="gia-tri">
                                            </div>
                                            <div class="form-group">
                                                <label for="email">Phương pháp phân tích</label>
                                                <input type="email" class="form-control" id="phuongphap-phantich">
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button id="saveMauBtn" type="button" class="btn btn-success" data-dismiss="modal">Thêm Kết Quả</button>
                                            <button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                        <div class="row">

                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <table id="sampledata-table"
                                       class="table table-striped table-bordered dataTable no-footer"
                                       role="grid">
                                    <thead>
                                        <tr role="row">
                                            <th class="column-title">STT</th>
                                            <th class="column-title">Chỉ tiêu</th>
                                            <th class="column-title">Đơn vị</th>
                                            <th class="column-title">Giá trị</th>
                                            <th class="column-title">Phương pháp phân tích</th>
                                            <th class="column-title"></th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-md-offset-2 col-md-10">
                                <input id="submitBtn" type="submit" value="Tạo" class="btn btn-success" />
                                <input type="button" class="btn btn-danger" value="Quay lại" onclick="location.href='@Url.Action("Index", "SoKQThuNghiem")'" />
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
}

<div>
    @Html.ActionLink("Back to List", "Index")
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        $(document).ready(function () {
            $('#NgayGuiMau').daterangepicker({
                singleDatePicker: true,
                calender_style: "picker_1"
            }, function (start, end, label) {
                console.log(start.toISOString(), end.toISOString(), label);
            });
        });
    </script>

    <script>
        $(document).ready(function () {
            $('#themMauModal').on('hidden.bs.modal', function () {
                $(this).find("input,textarea,select").val('').end();

            });

            function Delete() {
                var par = $(this).parent().parent(); //tr
                par.remove();
            }

            function OnRowIn() {
                var deleteCell = $(this).children().last();
                deleteCell.html("<a id='deleteRowBtn' href='#'><span class='glyphicon glyphicon-remove'></span></a>");
                $('#deleteRowBtn').bind("click", Delete);
            }

            function OnRowOut() {
                $(this).children().last().html('');
            }

            $("#saveMauBtn").bind("click", function () {
                var tabledata = $("#sampledata-table tbody");
                tabledata.append(
                    "<tr>" +
                    "<td>" + $("#stt").val() + "</td>" +
                    "<td>" + $("#chi-tieu").val() + "</td>" +
                    "<td>" + $("#don-vi").val() + "</td>" +
                    "<td>" + $("#gia-tri").val() + "</td>" +
                    "<td>" + $("#phuongphap-phantich").val() + "</td>" +
                    "<td></td>" +
                    "</tr>");

                //On Row Hover
                tabledata.children().last().hover(OnRowIn, OnRowOut)
            });


            $("#submitBtn").bind("click", function () {

                function getFormData() {
                    var res = {
                        KyHieuMau: $("#KyHieuMau").val(),
                        NoiLayMau: $("#NoiLayMau").val(),
                        NgayGuiMau: $("#NgayGuiMau").val(),
                        DiaChi: $("#DiaChi").val(),
                        LoaiMau: $("#LoaiMau").val(),
                        ViTriLayMau: $("#ViTriLayMau").val(),
                    };
                    var sampledata = $("#sampledata-table tbody tr").map(function (i, elem) {
                        var rowdata = $(elem).find("td").map(function () { return $(this).text(); }).get();
                        //alert(rowdata);
                        return {
                            STT: rowdata[1],
                            ChiTieu: rowdata[2],
                            DonVi: rowdata[3],
                            GiaTri: rowdata[4],
                            PhuongPhapPhanTich: rowdata[5]
                        }
                    }).get();
                    res.MauLayHienTruongs = sampledata;
                    //alert(res.toSource());
                    return res;
                }
                var formData = getFormData();
                $.ajax({
                    type: "POST",
                    url: '/Administrator/FormKQ/CreateNew/',
                    data: JSON.stringify(formData),
                    success: function (res) {
                        if (res.isOk) {
                            console.log(formdata);
                        } else {
                            console.log(res.errMsg);
                        }
                    },
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8'
                });
            });
        });
    </script>
}