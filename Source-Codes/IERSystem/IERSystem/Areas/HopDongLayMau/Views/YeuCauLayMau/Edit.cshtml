@model IERSystem.Areas.HopDongLayMau.Models.YeuCauLayMauEditOutputModel

@{
    ViewBag.Title = "Chỉnh sửa yêu cầu";
    Layout = "~/Areas/Administrator/Views/Shared/_Layout.cshtml";
}

<h2>Chỉnh sửa yêu cầu</h2>


@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()
    <div id="phieuyeucauedit-app" class="form-horizontal">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>Chỉnh sửa phiếu</h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <br>
                    <form id="form" class="form-horizontal form-label-left" novalidate="">
                        <div class="clearfix" />
                        <div class="item form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="name">
                                Tên khách hàng <span class="required">*</span>
                            </label>

                            <div class="col-md-6 col-sm-6 col-xs-12">
                                @Html.TextBoxFor(model => model.TenKhachHang, new { @class = "form-control col-md-4 col-xs-12" })
                                @Html.ValidationMessageFor(model => model.TenKhachHang)
                            </div>

                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">
                                Mã số thuế
                            </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                @Html.TextBoxFor(model => model.MaSoThue, new { @class = "form-control col-md-4 col-xs-12" })
                                @Html.ValidationMessageFor(model => model.MaSoThue)
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">
                                Người đại diện
                            </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                @Html.TextBoxFor(model => model.TenDaiDien, new { @class = "form-control col-md-4 col-xs-12" })
                                @Html.ValidationMessageFor(model => model.TenDaiDien)
                            </div>
                        </div>
                        <div class="item form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="telephone">
                                Số điện thoại <span class="required">*</span>
                            </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                @Html.TextBoxFor(model => model.SoDienThoai, new { @class = "form-control col-md-4 col-xs-12" })
                                @Html.ValidationMessageFor(model => model.SoDienThoai)
                            </div>
                        </div>
                        <div class="item form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">
                                Fax
                            </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                @Html.TextBoxFor(model => model.SoFax, new { @class = "form-control col-md-2 col-xs-12" })
                                @Html.ValidationMessageFor(model => model.SoFax)
                            </div>
                        </div>
                        <div class="item form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="occupation">
                                Nơi lấy mẫu <span class="required">*</span>
                            </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                @Html.TextBoxFor(model => model.DiaChiLayMau, new { @class = "form-control col-md-4 col-xs-12" })
                                @Html.ValidationMessageFor(model => model.DiaChiLayMau)
                            </div>
                        </div>
                        <div class="item form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="occupation">
                                Địa chỉ <span class="required">*</span>
                            </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                @Html.TextBoxFor(model => model.DiaChiKhachHang, new { @class = "form-control col-md-4 col-xs-12" })
                                @Html.ValidationMessageFor(model => model.DiaChiKhachHang)
                            </div>
                        </div>
                        <div class="item form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">
                                Ngày gửi/lấy mẫu <span class="required">*</span>
                            </label>
                            <div class="form-group input-group-sm col-md-6 col-sm-6 col-xs-12">
                                @Html.TextBoxFor(model => model.NgayLayMau, new { @class = "date-picker form-control col-md-7 col-xs-12 active", placeholder = "Nhập ngày gửi/lấy mẫu vào đây", required = "required", id = "NgayLayMau" })
                            </div>
                        </div>
                        <div class="item form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">
                                Ngày dự kiến trả mẫu <span class="required">*</span>
                            </label>
                            <div class="form-group input-group-sm col-md-6 col-sm-6 col-xs-12">
                                <select class="form-control col-md-4 col-xs-12" id="NgayHenTraKQ" required="required">
                                    <option>Chọn ngày trả mẫu</option>
                                    <option>2 ngày</option>
                                    <option>7 ngày</option>
                                    <option>10 ngày</option>
                                </select>
                            </div>
                        </div>

                        <h2 class="StepTitle">Thông Tin Các Mẫu</h2>
                        <div class="row">
                            @*<div class="col-md-2 col-sm-2 col-xs-2">
                                    <button id="btnThemMau" type="button"
                                            data-toggle="modal" data-target="#themMauModal"
                                            class="btn btn-success">
                                        Thêm Mẫu
                                    </button>
                                </div>*@
                            <!-- Modal -->
                            <div id="suaMauModal" class="modal fade" role="dialog">
                                <div class="modal-dialog">
                                    <!-- Modal content-->
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                                            <h4 class="modal-title">Modal Header</h4>
                                        </div>
                                        <div class="modal-body">
                                            <div class="form-group">
                                                <label for="email">Mã Mẫu</label>
                                                <input type="email" class="form-control" id="ma-mau">
                                            </div>
                                            <div class="form-group">
                                                <label for="email">Kí Hiệu Mẫu</label>
                                                <select id="kh-mau" class="form-control">
                                                    <option></option>
                                                    <option>NT: Nước Thải</option>
                                                    <option>NC: Nước Cấp</option>
                                                    <option>NM: Nước Mặt</option>
                                                    <option>KK: Không Khí</option>
                                                    <option>B: Bùn Thải</option>
                                                    <option>Đ: Đất</option>
                                                    <option>TP: Thực Phẩm</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label for="email">Vị Trí Lấy Mẫu <span class="required">*</span></label>
                                                <input type="email" class="form-control" id="vitri-laymau" required="required">
                                            </div>
                                            <div class="form-group">
                                                <div class="col-sm-8">
                                                    <label for="email">Số Lượng</label>
                                                    <input type="email" class="form-control" id="so-luong">
                                                </div>
                                                <div class="col-sm-4">
                                                    <label for="email">Đơn Vị</label>
                                                    <input type="email" class="form-control" id="don-vi">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="email">Mô Tả Mẫu <span class="required">*</span></label>
                                                <input type="email" class="form-control" id="mota-mau" required="required">
                                            </div>
                                            <div class="form-group">
                                                <label for="email">Loại Mẫu Theo Nhóm Chỉ Tiêu</label>
                                                <select id="loai-chitieu" class="form-control"></select>
                                            </div>
                                            <div class="form-group">
                                                <label for="email">Chỉ Tiêu Yêu Cầu <span class="required">*</span></label>
                                                <select class="select2_multiple form-control " multiple="multiple" required="required" id="chitieu-yeucau" style="width: 100%;">
                                                </select>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button v-on:click="saveMauEdited" type="button" class="btn btn-success" data-dismiss="modal">Thêm Mẫu</button>
                                            <button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="row">
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <table id="sampledata-table"
                                       class="table table-striped table-bordered dataTable no-footer"
                                       role="grid">
                                    <thead>
                                        <tr role="row">
                                            <th class="column-title">Mã Mẫu</th>
                                            <th class="column-title">KH Mẫu</th>
                                            <th class="column-title">Vị Trí Lấy Mẫu</th>
                                            <th class="column-title">Số Lượng</th>
                                            <th class="column-title">Mô Tả Mẫu</th>
                                            <th class="column-title">Chỉ Tiêu Yêu Cầu</th>
                                            <th class="column-title"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-bind:class="{ warning: (maupt.ModifiedState == 1), danger: (maupt.ModifiedState == 2) }"
                                            v-for="maupt in phieuyeucauedit.MauLayHienTruongs" role="row">
                                            <td>{{ maupt.KiHieuMau }}</td>
                                            <td>{{ maupt.MaMauKH }}</td>
                                            <td>{{ maupt.ViTriLayMau }}</td>
                                            <td>{{ renderedSoLuongPTCell(maupt) }}</td>
                                            <td>{{ maupt.MoTaMau }}</td>
                                            <td>{{ renderedChiTieuPTCell(maupt) }}</td>
                                            <td class="column-title">
                                                <button v-if="maupt.ModifiedState == 0"
                                                        title="Chỉnh sửa"
                                                        type="button"
                                                        v-on:click="openChinhMauModal(maupt)">
                                                    <span class="fa fa-edit"></span>
                                                </button>
                                                <button v-if="maupt.ModifiedState == 0"
                                                        title="Xóa"
                                                        type="button"
                                                        v-on:click="setDeleteMauPT(maupt)">
                                                    <span class="fa fa-trash"></span>
                                                </button>
                                                <button v-if="maupt.ModifiedState != 0"
                                                        title="Phục hồi"
                                                        type="button"
                                                        v-on:click="setRecoverMauPT(maupt)">
                                                    <span class="fa fa-reply"></span>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="ln_solid"></div>
                        <div class="form-group">
                            <div class="col-md-6 col-sm-6 col-xs-12 col-md-offset-5">
                                <input type="button" id="submitBtn" v-on:click="submitEditedData" value="Lưu" class="btn btn-success" />
                                <input type="button" class="btn btn-danger" value="Quay lại" data-toggle="modal" data-target="#confirmModal" />
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
}
<!-- Quay Lai Modal -->
<div id="confirmModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-body">
                <h4>Bạn có chắc chắn muốn quay lại?</h4>
                <h5>Những thông tin bạn đã nhập sẽ không được lưu vào dữ liệu hệ thống.</h5>
                <div class="form-group" align="center">
                    <button type="submit" class="btn btn-success"
                            data-dismiss="modal"
                            onclick="turnBack()">
                        <span class="fa fa-check"></span>
                    </button>
                    <button type="button" class="btn btn-danger"
                            data-dismiss="modal">
                        <span class="fa fa-close"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script src="~/Areas/Administrator/vendors/vuejs/vue.min.js"></script>

    <script>
        $(document).ready(
            function () {
                $('#NgayLayMau').daterangepicker({
                    singleDatePicker: true,
                    calender_style: "picker_1"
                }, function (start, end, label) {
                    console.log(start.toISOString(), end.toISOString(), label);
                });
            });
    </script>
    
    <!-- VueJS App -->
    <script>
        var $CacheChiTieu = {};
        var $OldMauPTVersions = [];
        var $MauPTModifiedTarget_Id = undefined;
        $(document).ready(function () {
            @*nthoang: Insert default date difference into NgayHenTraKQ selectbox*@
            $("#NgayHenTraKQ").val('@(Model.NgayHenTraKQ)' + ' ngày');
        });
        
        @*nthoang: Temporary solution to parse uri string to get id, last element of url splitted by '/' token*@
        function getIdFromUrl() {
            var url_parts = location.href.split("/");
            return url_parts[url_parts.length - 1];
        }

        function reloadChiTieuMultiBox(chitieu_selected_data) {
            //nthoang: AJAX call ChiTieuMau suggestion list
            var formData2 = {
                TenNhom: $("#loai-chitieu").val()
            };
            if (!(formData2.TenNhom in $CacheChiTieu)) {
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("FindChiTieu", "API", new { area = "BaoGiaChiTieu" })',
                    data: JSON.stringify(formData2),
                    success: function (res) {
                        $("#chitieu-yeucau").empty();
                        $CacheChiTieu[formData2.TenNhom] = res;
                        res.forEach(function (item) {
                            $("#chitieu-yeucau").append("<option>" + item.TenChiTieu + "</option>");
                        });
                        $phieuyeucauedit_app.chitieupt_selectbox = res;
                        $("#chitieu-yeucau").val(chitieu_selected_data).trigger('change');
                    },
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8'
                });
            } else {
                $("#chitieu-yeucau").empty();
                var cached_ct = $CacheChiTieu[formData2.TenNhom];
                cached_ct.forEach(function (item) {
                    $("#chitieu-yeucau").append("<option>" + item.TenChiTieu + "</option>");
                });
                $phieuyeucauedit_app.chitieupt_selectbox = cached_ct;
                $("#chitieu-yeucau").val(chitieu_selected_data).trigger('change');
            }
        }

        @*nthoang: Preload NhomChiTieu for this maupt and also its correspondent list of ChiTieuPhanTich*@
        $.ajax({
            type: 'GET',
            url: ' @Url.Action("GetNhomChiTieu", "API", new { area = "BaoGiaChiTieu" })',
            success: function (res) {
                var loaimau_selectbox = $("#loai-chitieu");
                loaimau_selectbox.append("<option></option>");
                res.forEach(function (item) {
                    loaimau_selectbox.append("<option>" + item.TenNhom + "</option>");
                });
                loaimau_selectbox.change(function () {
                    reloadChiTieuMultiBox([]);
                });
            },
            dataType: 'json',
            contentType: 'application/json; charset=utf-8'
        });

        @*nthoang: Load all Phieu Yeu Cau data first using server side rendering*@
        var $phieuyeucauedit_app = new Vue({
            el: '#phieuyeucauedit-app',
            data: {
                chitieupt_selectbox: [],
                @*nthoang: This is the input model (To be submitted to server)*@
                phieuyeucauedit: {
                    MauLayHienTruongs: []
                }
            },
            methods: {
                renderedSoLuongPTCell: function (maupt) {
                    return maupt.SoLuong + " " + maupt.DonVi;
                },
                renderedChiTieuPTCell: function (maupt) {
                    return maupt.ChiTieuPhanTiches.map(function (e) { return e.TenChiTieu }).join(", ");
                },
                setDeleteMauPT: function (maupt) {
                    maupt.ModifiedState = 2;
                },
                submitEditedData: function () {
                    $("#submitBtn").prop("disabled", true);
                    var submitData = {
                        @*nthoang: Convert Id string from url to number*@
                        Id: Number(getIdFromUrl()),
                        @*nthoang: Populate input model with loaded Phieu Yeu Cau data (Server rendering)*@
                        TenKhachHang: $("#TenKhachHang").val(),
                        MaSoThue: $("#MaSoThue").val(),
                        TenDaiDien: $("#TenDaiDien").val(),
                        SoDienThoai: $("#SoDienThoai").val(),
                        SoFax: $("#SoFax").val(),
                        DiaChiLayMau: $("#DiaChiLayMau").val(),
                        DiaChiKhachHang: $("#DiaChiKhachHang").val(),
                        NgayLayMau: $("#NgayLayMau").val(),
                        NgayHenTraKQ: $("#NgayHenTraKQ").val().split(" ")[0],
                        MauLayHienTruongs: $phieuyeucauedit_app.phieuyeucauedit.MauLayHienTruongs.map(function (mpt) {
                            mpt.KiHieuMau = mpt.KiHieuMau.split(":")[0];
                            mpt.ChiTieuPhanTiches = mpt.ChiTieuPhanTiches.map(function (ctpt) { return { Id: ctpt.Id }; });
                            return mpt;
                        })
                    };
                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("Edit", "API")',
                        data: JSON.stringify(submitData),
                        error: function () {
                            $("#submitBtn").prop("disabled", false);
                            new PNotify({
                                title: 'Thất bại',
                                text: 'có lỗi xảy ra trong lúc truyền dữ liệu, bạn vui lòng thử lại sau',
                                type: 'error',
                                styling: 'bootstrap3'
                            });
                        },
                        success: function (res) {
                            $("#submitBtn").prop("disabled", false);
                            if (res.IsOK) {
                                new PNotify({
                                    title: 'Thành công',
                                    text: 'chỉnh sửa hợp đồng mới hợp lệ, thông tin hợp đồng đã được cập nhật vào lưu trữ',
                                    type: 'success',
                                    styling: 'bootstrap3'
                                });
                                new PNotify({
                                    title: 'Thông tin',
                                    text: res.ErrMsg,
                                    type: 'info',
                                    styling: 'bootstrap3'
                                });
                                setTimeout(function () {
                                    window.location.href = '@Url.Action("Index", "YeuCauLayMau")'
                                }, 1500);
                            } else {
                                $("#submitBtn").prop("disabled", false);
                                new PNotify({
                                    title: 'Thất bại',
                                    text: 'Có lỗi khi cập nhật thông tin hợp đồng, bạn vui lòng thử lại sau.',
                                    type: 'error',
                                    styling: 'bootstrap3'
                                });
                                new PNotify({
                                    title: 'Thông tin',
                                    text: res.ErrMsg,
                                    type: 'info',
                                    styling: 'bootstrap3'
                                });
                            }
                        },
                        dataType: 'json',
                        contentType: 'application/json; charset=utf-8'
                    });
                },
                setRecoverMauPT: function (maupt) {
                    if (maupt.ModifiedState == 2) {
                        maupt.ModifiedState = 0;
                    } else {
                        var default_maupt = $OldMauPTVersions.find(function (e) {
                            return e.Id == maupt.Id;
                        });
                        maupt.ModifiedState = 0;
                        maupt.MaMauKH = default_maupt.MaMauKH;
                        maupt.KiHieuMau = default_maupt.KiHieuMau;
                        maupt.ViTriLayMau = default_maupt.ViTriLayMau;
                        maupt.SoLuong = default_maupt.SoLuong;
                        maupt.DonVi = default_maupt.DonVi;
                        maupt.MoTaMau = default_maupt.MoTaMau;
                        maupt.ChiTieuPhanTiches = default_maupt.ChiTieuPhanTiches;
                    }
                },
                saveMauEdited: function () {
                    var target_maupt = $phieuyeucauedit_app.phieuyeucauedit.MauLayHienTruongs.find(function (e) {
                        return e.Id == $MauPTModifiedTarget_Id;
                    });
                    var old_maupt = {};
                    old_maupt.Id = target_maupt.Id;
                    old_maupt.ModifiedState = 0;
                    target_maupt.ModifiedState = 1;
                    old_maupt.MaMauKH = target_maupt.MaMauKH;
                    target_maupt.MaMauKH = $("#ma-mau").val();
                    old_maupt.KiHieuMau = target_maupt.KiHieuMau;
                    target_maupt.KiHieuMau = $("#kh-mau").val();
                    old_maupt.ViTriLayMau = target_maupt.ViTriLayMau;
                    target_maupt.ViTriLayMau = $("#vitri-laymau").val();
                    old_maupt.SoLuong = target_maupt.SoLuong;
                    target_maupt.SoLuong = $("#so-luong").val();
                    old_maupt.DonVi = target_maupt.DonVi;
                    target_maupt.DonVi = $("#don-vi").val();
                    old_maupt.MoTaMau = target_maupt.MoTaMau;
                    target_maupt.MoTaMau = $("#mota-mau").val();
                    old_maupt.ChiTieuPhanTiches = target_maupt.ChiTieuPhanTiches;
                    target_maupt.ChiTieuPhanTiches = $("#chitieu-yeucau").val().map(function (ten_chitieu) {
                        return {
                            Id: $phieuyeucauedit_app.chitieupt_selectbox.find(function (ctpt) {
                                return ctpt.TenChiTieu == ten_chitieu;
                            }).Id,
                            NhomChiTieu: $("#loai-chitieu").val(),
                            TenChiTieu: ten_chitieu
                        };
                    });
                    $OldMauPTVersions.push(old_maupt);
                },
                openChinhMauModal: function (maupt) {
                    $("#ma-mau").val(maupt.MaMauKH);
                    $("#kh-mau").val(maupt.KiHieuMau);
                    $("#vitri-laymau").val(maupt.ViTriLayMau);
                    $("#so-luong").val(maupt.SoLuong);
                    $("#don-vi").val(maupt.DonVi);
                    $("#mota-mau").val(maupt.MoTaMau);
                    $("#loai-chitieu").val(maupt.ChiTieuPhanTiches[0].NhomChiTieu);
                    reloadChiTieuMultiBox(maupt.ChiTieuPhanTiches.map(function (e) { return e.TenChiTieu; }));
                    $("#suaMauModal").modal("toggle");
                    @*Target maupt id for edit*@
                    $MauPTModifiedTarget_Id = maupt.Id;
                }
            }
        });

        @*nthoang: Mau Phan Tich list to be loaded later using ajax*@
        $.ajax({
            type: 'GET',
            url: '@Url.Action("GetMauPTs", "API")/?id=' + getIdFromUrl(),
            success: function (res) {
                if (res.IsOK) {
                    var mapped_result = res.Data.forEach(function (e) {
                        e.ModifiedState = 0;
                        @*nthoang: Mau Phan Tich table is loaded after ajax call*@
                        $phieuyeucauedit_app.phieuyeucauedit.MauLayHienTruongs.push(e);
                    });
                } else {
                    alert("Co loi khi lay mau phan tich cho phieu yeu cau id " + getIdFromUrl());
                }
            },
            dataType: 'json',
            contentType: 'application/json; charset=utf-8'
        });
    </script>

    <!-- validator -->
    <script>
        // initialize the validator function
        validator.message.date = 'Không phải ngày thật';

        //validate a field on "blur" event, a 'select' on 'change' event & a '.reuired' classed multifield on 'keyup':
        $('form')
          .on('blur', 'input[required], input.optional, select.required', validator.checkField)
          .on('change', 'select.required', validator.checkField)
          .on('keypress', 'input[required][pattern]', validator.keypress);

        $('.multi.required').on('keyup blur', 'input', function () {
            validator.checkField.apply($(this).siblings().last()[0]);
        });

        function turnBack() {
            new PNotify({
                title: 'Chuyển trang',
                text: 'bạn đang được chuyển sang trang chủ.',
                type: 'success',
                styling: 'bootstrap3'
            });
            setTimeout(function () {
                window.location.href = '@Url.Action("Index", "YeuCauLayMau")'
            }, 1500);

        }

        //get Maus
        function get() {
            $.ajax({
                type: 'POST',
                url: ' @Url.Action("GetMauPT", "API")',
                data: JSON.stringify({ Id: id }),
                success: function (res) {
                    if (res.IsOK) {
                        var result = Data;

                    } else {
                        console.log("Có lỗi khi mở sổ nhận mẫu " + id);
                    }
                },
                dataType: 'json',
                contentType: 'application/json; charset=utf-8'
            })
        }
    </script>
    <!-- /validator -->
}
